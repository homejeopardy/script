<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Line Rehearsal Tool</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2212%22>üé≠</text></svg>">
<style>
:root {
  --bg: #f9f9f9;
  --text: #222;
  --accent: #007aff;
  --progress: #4caf50;
}
.dark {
  --bg: #121212;
  --text: #eee;
  --accent: #0a84ff;
  --progress: #66bb6a;
}
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 2rem;
  transition: background 0.3s, color 0.3s;
}
h1 { font-weight: 600; }
button, input[type="file"], select {
  background: var(--accent);
  color: white;
  border: none;
  padding: 0.6rem 1rem;
  border-radius: 0.5rem;
  cursor: pointer;
  font-size: 1rem;
}
button:hover { opacity: 0.9; }
input, select { margin: 0.5rem 0; }
#display { 
  margin-top: 2rem;
  padding: 2rem;
  border: 2px solid var(--accent);
  border-radius: 1rem;
  text-align: center;
  max-width: 600px;
  min-height: 6rem;
  cursor: pointer;
  user-select: none;
}
.progress-container {
  width: 100%;
  background: #ccc;
  border-radius: 0.5rem;
  overflow: hidden;
  margin: 1rem 0;
}
.progress-bar {
  height: 1rem;
  width: 0%;
  background: var(--progress);
  transition: width 0.3s;
}
.settings {
  margin-top: 1rem;
}
.hidden { display: none; }
select, input[type="range"] { width: 100%; }
footer { margin-top: 2rem; font-size: 0.8rem; opacity: 0.7; }
.fade-in {
  animation: fade 1s ease-in;
}
@keyframes fade {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>
</head>
<body>

<h1>üé≠ Line Rehearsal Tool</h1>

<input type="file" id="fileInput">
<br>
<input type="text" id="characterInput" placeholder="Your Character Name">
<br>
<button onclick="start()">Start Rehearsal</button>

<div class="progress-container">
  <div class="progress-bar" id="progressBar"></div>
</div>

<div id="display" onclick="nextLine()" class="hidden"></div>

<div class="settings">
  <button onclick="toggleSettings()">Settings ‚öôÔ∏è</button>
  <div id="settingsPanel" class="hidden">
    <label>TTS Speed</label>
    <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1">
    <label>TTS Pitch</label>
    <input type="range" id="pitchControl" min="0" max="2" step="0.1" value="1">
    <label>Theme</label>
    <select onchange="setTheme(this.value)">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
    <button onclick="toggleTTS()">
      Toggle TTS: <span id="ttsStatus">On</span>
    </button>
  </div>
</div>

<footer>Auto-saving progress...</footer>

<script>
let lines = [], myLines = [], index = 0, ttsOn = true;
const display = document.getElementById('display');
const progressBar = document.getElementById('progressBar');

function start() {
  const file = document.getElementById('fileInput').files[0];
  const character = document.getElementById('characterInput').value.trim().toUpperCase();
  if (!file || !character) return alert('Upload script and enter your character name.');
  
  const reader = new FileReader();
  reader.onload = e => {
    lines = e.target.result.split('\n');
    extractLines(character);
  };
  reader.readAsText(file);
}

function extractLines(character) {
  myLines = [];
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].trim() === character) {
      let cue = findCue(i - 1);
      let line = lines[i + 1] || '';
      myLines.push({cue, line});
    }
  }
  if (myLines.length === 0) return alert('No lines found for this character.');
  index = 0;
  display.classList.remove('hidden');
  nextLine();
}

function findCue(idx) {
  while (idx >= 0) {
    if (lines[idx].trim() && lines[idx] === lines[idx].toUpperCase()) return lines[idx];
    idx--;
  }
  return '(Start)';
}

function nextLine() {
  if (index >= myLines.length) return finish();
  const {cue, line} = myLines[index];
  display.innerHTML = `<div class="fade-in"><strong>Cue:</strong> ${cue}<br><br><strong>Your Line:</strong> ${line}</div>`;
  progressBar.style.width = ((index + 1) / myLines.length) * 100 + '%';
  if (ttsOn) speak(cue);
  localStorage.setItem('lineProgress', index);
  index++;
}

function finish() {
  const messages = ["Bravo!", "Encore!", "You crushed it!", "Legendary performance!", "Well done, superstar!"];
  const msg = messages[Math.floor(Math.random() * messages.length)];
  display.innerHTML = `<div class="fade-in">${msg}</div>`;
  progressBar.style.width = '100%';
}

function speak(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.rate = parseFloat(document.getElementById('speedControl').value);
  utter.pitch = parseFloat(document.getElementById('pitchControl').value);
  speechSynthesis.speak(utter);
}

function toggleSettings() {
  document.getElementById('settingsPanel').classList.toggle('hidden');
}

function toggleTTS() {
  ttsOn = !ttsOn;
  document.getElementById('ttsStatus').textContent = ttsOn ? 'On' : 'Off';
}

function setTheme(theme) {
  document.body.classList.toggle('dark', theme === 'dark');
}

window.onload = () => {
  const saved = localStorage.getItem('lineProgress');
  if (saved) index = parseInt(saved);
};
</script>

</body>
</html>
